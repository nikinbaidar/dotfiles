#! /bin/bash

function deleteElements() {
    for (( k = 0 ; k < ${#indexes_to_delete[@]} ; k++ ))
    do
        length=${#my_array[@]}
        popIndex=$(( ${indexes_to_delete[$k]} - ${k} ))
        unset my_array[$popIndex]
        # After deleting an element shift all elements from the empty spot,
        # once place to the left, skip if the last element was deleted.
        if (( ${popIndex}+1 != ${length} )) ; then
            for (( j=${popIndex} + 1; j < ${length} ; j++ ))
            do
                my_array[$popIndex]=${my_array[$j]}
                (( popIndex++ ))
            done
            unset my_array[-1]
        fi
    done
    unset indexes_to_delete
}

function changeTrackTitle() {
    echo -n "Enter the track title or press enter to skip:" ; read title
    if ! [ -z ${title} ] ; then
        mid3v2 --song "${title}" "${1}"
    else
        title="$(basename -s .mp3 ${file})"
        mid3v2 --song "${title}" "${1}"
        title=0
    fi
}

function changeTrackNumber() {
    echo -n "Enter the track number or press enter to skip:" ; read track_num
    if ! [ -z ${track_num} ] ; then
        mid3v2 --track "${track_num}" "${1}"
    fi
}

function changeArtistandAlbum() {
printf "\e[00;34mFiles To Modify:\e[00;37m\n"

length=${#my_array[@]}
for (( i = 0 ; i < ${length} ; i++ ))
do
    echo "${i}) ${my_array[$i]}"
done

echo -e "\nEnter the indexes of files for which you wish to set the album" \
"and artist names for. Press 'a' for all."
read indexes

echo -n "Enter the album name (Default: Greatest Hits):" ; read album
if [ -z ${album} ] ;then
    album="Greatest Hits"
fi

echo -n "Enter the artist name:" ; read artist

if [[ ${indexes} = a ]] ; then
    for item in "${my_array[@]}"
    do
        mid3v2 --artist "${artist}" --album "${album}" "${item}"
    done
    IFS="${IFS_OLD}"
    exit 111;
fi

declare -a indexes_to_delete

count=0
IFS=$' '

for i in ${indexes}
do
    mid3v2 --artist "${artist}" --album "${album}" "${my_array[i]}"
    indexes_to_delete[${count}]=$i
    (( count++ ))
done

IFS=$'\n'

deleteElements
}

# Main

IFS_OLD=${IFS}
IFS=$'\n'

cd ~/Music

for file in $(find ./* -cmin -60)
# for file in $(find ./*.mp3 -iname "slipknot*")
do
    fileName=$(basename "${file}")
    printf "Current Selection is: \e[00;31m${fileName}\e[00;37m\n"
    mid3v2 --list-raw ${file}
    echo -n "Delete existing metadata?[n/y]" ; read answer
    if [ "${answer}" = y ] ; then
        mid3v2 -d "${file}"
    fi

    changeTrackTitle "${file}"
    changeTrackNumber "${file}"

    if [[ ${title} = 0 || "${title}" = "$(basename -s .mp3 ${file})"  ]]
    then
        echo -e "Skipping renaming...\n"
        my_array[track_count]=$(basename "${file}")
    else
        mv --interactive "${file}" "${title}".mp3 # prompt before overwriting
        my_array[track_count]="${title}.mp3"
    fi

    (( track_count++ ))
done

echo -n "Do you wish to set album and artist names?[y/n]" ; read answer

if [[ ${answer} = n ]] ; then
    IFS=${IFS_OLD}
    exit 111
fi

while [ ${#my_array[@]} -gt 0 ]
do
    changeArtistandAlbum
done
